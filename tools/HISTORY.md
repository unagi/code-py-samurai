# tools/ — 失敗した手法の記録

試して失敗・放棄した手法のログ。同じ轍を踏まないための参考資料。

---

## 1. ImageMagick flood-fill 透過
- **手法**: 画像の8点 (四隅 + 各辺中央) から flood-fill で背景を透明化
- **パラメータ**: `-fuzz 6%` (透過), `-fuzz 15%` (トリム), 下部10%カット (ラベル除去)
- **結果**: サムライ猫を含む全キャラ (15画像) の切り出しに成功
- **問題**: 全パラメータが手動チューニング。画像ごとに調整が必要で汎用性なし
- **教訓**: rembg の方がパラメータ不要で圧倒的に使いやすい

## 2. PIL 閾値ベース背景判定
- **手法**: `R<80,G<80,B<80` → 暗い背景、`R>140` かつ RGB差<25 → チェッカーボード、として透明化
- **結果**: idle/walk/tiles の切り出しに成功
- **問題**: 閾値がハードコード。画像の色味が変わると破綻

## 3. Node.js sharp 版グリッド分割
- **手法**: sharp ライブラリでグリッド分割
- **結果**: 精度不足で放棄。Python版に移行

## 4. PowerShell グリッド検出
- **手法**: ImageMagick + PowerShell でグリッド線を検出
- **結果**: 文字化け問題 (Shift-JIS/UTF-8混在) で出力が読めず放棄

## 5. ToonCrafter ローカル推論 (RTX 4060)
- **目的**: キーフレーム間の中間フレームをAI生成し、アニメーションを滑らかにする
- **環境**: RTX 4060 (8GB VRAM), PyTorch 2.0+cu118, 10.5GB モデル
- **問題1**: xformers 0.0.27 が PyTorch 2.4 必須。SDPA fallback を実装したが全フレーム真っ黒
- **問題2**: fp32 だと VRAM 溢れ (21GB peak)、Windows WDDM で system RAM に退避するが 42分/25steps
- **結論**: RTX 4060 では実用不可。HF Space (クラウド) 版を使うこと → PIPELINE.md 参照

## 6. Lab 色空間 色補正
- **目的**: ToonCrafter 出力の色ずれ (オレンジ耳問題等) を Reinhard color transfer で補正
- **結果**: 部分的に改善したが、根本的な品質改善には至らず

## 7. Stable Diffusion ControlNet フレーム補正（旧案: 2枚間補間）
- **目的**: SD + ControlNet (Canny/Lineart) でキーフレーム間の補間品質を改善
- **結果**: 実装途中で中断。フレーム間の一貫性維持が困難
- **備考**: 現在は「1枚入力から次フレーム候補を作る」方針へ切替
  - 実装: `pipeline/phase7_sd_nextframe.py`
  - 判定: 差分ゲート + 人手レビュー

## 8. 幾何学変形ベースの擬似モーション
- **問題**: 回転/拡縮/平行移動で作った動きは、アニメーション品質の要求に合わない
- **結論**: 呼び出し側はセマンティック指定のみとし、内部はモーション専用モデルを利用
- **現行方針**:
  - 実装: `pipeline/phase7_semantic_motion.py`
  - 手法: AnimateDiff + ControlNet

## 9. 固定4分割評価のみで部位指定が弱い問題
- **問題**: 動かす部位（しっぽ/肩など）に応じた局所評価ができず、判定が粗い
- **対応**: 可変グリッド評価へ拡張
  - `--motion-grid NxM`
  - `--motion-focus-cells r<row>c<col>,...`
  - `--motion-target <name>`
- **補足**: 時系列差分の山型（増加→減少）判定を追加し、`--require-temporal-wave` でゲート可能

## 10. 生成後のジャギ/ノイズ低減を手動運用していた問題
- **問題**: Upscayl 2段処理（2x→2x→元サイズ）が手動で再現性に欠ける
- **対応**: `phase7_semantic_motion.py` に後処理を統合
  - `--post-upscale-chain`
  - `--upscayl-bin`, `--upscayl-model-dir`, `--upscayl-model-name`
  - `--upscayl-passes`, `--upscayl-scale-per-pass`
  - `--post-downscale-filter`
- **方針**: 後処理失敗時は停止（暗黙フォールバックしない）

## 11. 単一フレーム起点の SD/AnimateDiff モーション生成の最終評価
- **対象**: `phase7_sd_nextframe.py` / `phase7_semantic_motion.py`
- **評価結果**: 本流不採用（御蔵入り）
- **観察された症状**:
  - 差分量は増やせるが、狙った部位の形状変化より全身の色味・質感揺れが優先される
  - 「しっぽを動かす」要求に対し、差分が全身へ分散しやすい
  - 単一フレーム入力では、端点拘束が不足して再現性が低い
- **結論**:
  - 本流戦略は `2フレーム以上の端点を用意 -> ToonCrafterで中割り`
  - 単一フレームからのSD系フレーム捏造は、検証用途に留める

## 12. 再発防止（同じ轍を踏まないためのルール）
- **禁止（本番スプライト生成）**:
  - `1枚入力 -> SD/AnimateDiff + ControlNet` を主戦略にしてパラメータ調整を回し続けること
- **理由**:
  - 差分スコアは色変化で稼げるため、局所形状運動の成功を保証しない
  - `motion-target` / `motion-focus-cells` は現状主に評価側の情報であり、生成拘束としては弱い
- **再挑戦の前提条件（満たさない限り再開しない）**:
  - ROI固定合成（例: しっぽ以外を元フレームで固定）
  - ROI内差分 / ROI外差分の分離評価
  - または、フレームごとに異なる条件画像（端点/中間形状）を用意
- **優先順位**:
  1. 端点フレームの確保（抽出しやすいイラスト生成）
  2. ToonCrafter による中割り
  3. 必要時のみ後処理・監査

## 13. Gemini 5×5 グリッドは生成精度が落ちる
- **目的**: 敵キャラ1体分のフレーム（20+セル）を一括生成
- **試行**: 5行×5列=25セルで Gemini に依頼
- **結果**: セル間の一貫性が低下。キャラの配色・体型・ポーズの統一感が崩れる
- **結論**: **4行×5列=20セルが安全圏、4行×6列=24セルがギリギリの上限**
- **教訓**: セル数を増やすほど品質は落ちる。多くても24セルまで

## 14. Gemini は east/west（左右の向き）の指定を無視する
- **問題**: プロンプトで `west = 左向き, east = 右向き` と厳密に指示しても、
  生成されたセルの向きはランダムに混在する（行単位でも揃わない）
- **実例**: Row1=L idle, Row2=L attack+R attack+R damaged+R death（混在）
- **対処**: 抽出後に**全セルの向きを目視判定**し、左右を振り分ける
- **教訓**: Gemini の方向指定は参考程度。事後の手作業前提でフローを組む

## 15. Idle フレーム順序決定には CV パイプラインが必要
- **問題**: Gemini で生成した idle フレームは意味的な順序を持たない（ランダム配置）
- **発見**: 目視で順序を決めるのは非効率。CV で自動化できる
- **手法**: Edge + Distance Transform + Phase Correlation + ECC (Euclidean) + L1 距離行列
  → 最遠ペア → 最近傍チェイン → 2-opt 改善 → A→B1→C→B2 サイクル選定
- **ポイント**:
  - DT (Distance Transform) が肝。ピクセル単位のエッジ差分より滑らかで安定
  - Phase Correlation で粗合わせ → ECC で回転+微調整の2段が実務で安定
  - ping-pong (A→B→C→B→A) ではなく、4キーフレーム全て異なるサイクル (A→B1→C→B2→A)
  - 左右 idle で異なる C 端点を採用すると変化が出て良い
- **実装**: `tools/pipeline/frame_order.py`

## 16. 敵キャラのスプライトは 320px (Retina 4×) で制作する
- **問題**: 80px で正規化すると小さすぎてディテールが潰れる
- **解決**: 320×320px（= 80 × 4）で制作 → ゲームエンジン側で縮小表示
- **理由**: 80 の整数倍なのでサブピクセル誤差なし、Retina ディスプレイ対応も兼ねる
- **スプライトシート**: 4f idle → 1280×320px
